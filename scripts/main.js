var P=Object.defineProperty;var M=(i,t,e)=>t in i?P(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var S=(i,t,e)=>M(i,typeof t!="symbol"?t+"":t,e);class C{static stringToHtmlElement(t){const e=document.createElement("div");return e.innerHTML=t,e.firstChild}}let T=null;const L="alien-roll-request";function f(){if(T)return T;const i=`/modules/${L}/templates/`;return T={moduleId:L,templatePath:i},T}function O(){game.settings.register(L,"hostile",{name:game.i18n.localize("DICEROLLREQUEST.SETTINGS.title"),hint:game.i18n.localize("DICEROLLREQUEST.SETTINGS.details"),scope:"world",config:!0,type:Boolean,default:!1})}class g{constructor(t){if(this.token=t,!this.tokenIsValidActor())throw new Error("Token is not a suitable actor")}getSkill(t){var e,n,s,o,r;return(n=(e=this.token.actor)==null?void 0:e.system)!=null&&n.skills[t]||console.error(`Skill ${attributeName} not found`),((r=(o=(s=this.token.actor)==null?void 0:s.system)==null?void 0:o.skills[t])==null?void 0:r.value)??0}getAttribute(t){var e,n,s,o,r;return(n=(e=this.token.actor)==null?void 0:e.system)!=null&&n.attributes[t]||console.error(`Attribute ${t} not found`),((r=(o=(s=this.token.actor)==null?void 0:s.system)==null?void 0:o.attributes[t])==null?void 0:r.value)??0}getStressValue(){return this.token.actor.system.header.stress.value}getPanicValue(){var t,e,n,s,o,r;return((n=(e=(t=this.token.actor.system)==null?void 0:t.general)==null?void 0:e.panic)==null?void 0:n.value)===1?(r=(o=(s=this.token.actor.system)==null?void 0:s.general)==null?void 0:o.panic)==null?void 0:r.lastRoll:0}getLastPanicMessage(){return this.token.actor.morePanic(this.getPanicValue())}getId(){return this.token.id}getName(){return this.token.name}getActor(){return this.token.actor}getOwners(t=!1){var e;return(e=game==null?void 0:game.users)==null?void 0:e.filter(n=>n.character===this.token.actor&&(t?n.active:!0))}tokenIsValidActor(){return!!this.token&&!!this.token.actor}static getTokenFromId(t){const e=canvas.tokens.get(t);return new this(e)}static getTokenFromActorId(t){const e=canvas.tokens.placeables.find(n=>{var s;return((s=n.actor)==null?void 0:s.id)===t});return new this(e)}static getPlayersFromList(t){const e=f(),n=[CONST.TOKEN_DISPOSITIONS.FRIENDLY,game.settings.get(e.moduleId,"hostile")?CONST.TOKEN_DISPOSITIONS.HOSTILE:null].filter(Boolean);try{return t.filter(s=>{var o;return((o=s.actor)==null?void 0:o.type)==="character"&&n.includes(s.document.disposition)})}catch{return console.error("Not a suitable list of tokens"),{}}}}class m{static async create(t){await ChatMessage.create(t)}static deleteMessage(t,e=!1){!t||!t instanceof ChatMessage||(this.isUserMessageOwner(t)?m.deleteMessageFromDb(t):e&&game.socket.emit("module.alien-roll-request",{action:"delete-roll-request",messageId:t.id}))}static deleteMessageFromDb(t){!t||!this.isUserMessageOwner(t)||t==null||t.delete()}static cleanChatMessageByClassName(t="message"){document.querySelectorAll(`.chat-message:has(.${t})`).forEach(e=>{const n=ChatMessage.get(e.dataset.messageId);m.deleteMessage(n)})}static isUserMessageOwner(t){return!t||!t instanceof ChatMessage,t.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER)}static setMessageCreationListener(t){game.socket.on("module.alien-roll-request",e=>{if(e.action==="delete-roll-request"){const n=ChatMessage.get(e.messageId);m.deleteMessage(n)}}),Hooks.on("createChatMessage",e=>{var n,s,o,r;if(e.isRoll&&((o=(s=(n=e.rolls[0])==null?void 0:n.terms[0])==null?void 0:s.constructor)==null?void 0:o.name)==="AlienRPGBaseDie"){const a=C.stringToHtmlElement(e.content),l=g.getTokenFromActorId(a==null?void 0:a.dataset.actorId)??g.getTokenFromId((r=e.speaker)==null?void 0:r.token);setTimeout(()=>{e.update({speaker:{alias:l.getName()}})},100);const c=e.rolls[0];c&&l&&t.logRollResult(l,c)}Hooks.on("updateActor",(a,l,c,u)=>{var d,h;if((h=(d=l.system)==null?void 0:d.general)!=null&&h.panic){const k=g.getTokenFromActorId(a.id);t.syncPanic(k)}})})}static setCommonListeners(){Hooks.on("renderChatMessage",(t,e,n)=>{var s;(s=e.find(".rollable"))==null||s.on("click",o=>{var c;const a=o.currentTarget.dataset,l=g.getTokenFromId(a==null?void 0:a.token).token;(c=l==null?void 0:l.actor)==null||c.rollAbility(l==null?void 0:l.actor,a),m.deleteMessage(t,!0)})})}}const D="/systems/alienrpg/template.json";let b=null;async function N(){if(b)return b;const i=await A();return b={attributes:i.Actor.character.attributes,skills:i.Actor.character.skills},b}async function A(){const i=new URL(D,import.meta.url).href,t=await fetch(i);if(!t.ok)throw new Error(`Failed to load alien template.json: ${t.statusText}`);return await t.json()}async function F(i){var s,o,r,a,l,c;const t=await A(),e=(o=(s=t.Actor)==null?void 0:s.character)==null?void 0:o.attributes,n=(a=(r=t.Actor)==null?void 0:r.character)==null?void 0:a.skills;if(!e)return null;for(const u in e)if(((l=e[u])==null?void 0:l.label)===i)return u;for(const u in n)if(((c=n[u])==null?void 0:c.label)===i)return u;return null}function I(i){const t=i.charAt(0).toUpperCase()+i.slice(1);return w(`ALIENRPG.Skill${i}`)??w(`ALIENRPG.Ability${t}`)}function w(i){return game.i18n.localize(i)!==i?game.i18n.localize(i):null}function H(i,t){let e={};for(const n in t)e[n]=Object.entries(i).filter(([s,o])=>o.ability===n).reduce((s,[o,r])=>(s[o]=r,s),{});return e}const E=class E{constructor(t,e,n,s=!1){this.token=t,this.type=e,this.key=n,this.isPush=s,this.rollName="randomRoll",this.diceNumber=0,this.template="rollRequest.html"}async createRollNotification(t=[]){await this.determineDicesForRoll();const n=`${f().templatePath}${this.template}`,s=await F(this.rollName),o=I(s),r=await renderTemplate(n,{tokenId:this.token.getId(),tokenName:this.token.getName(),label:o,number:this.diceNumber}),a={whisper:t,type:CONST.CHAT_MESSAGE_STYLES.OTHER,content:r};await m.create(a)}async determineDicesForRoll(){var e;const t=await N();switch(this.type){case E.RollTypeEnum.skill:const n=(e=t==null?void 0:t.skills[this.key])==null?void 0:e.ability;this.diceNumber=this.token.getSkill(this.key)+this.token.getAttribute(n),this.rollName=I(this.key)??"undefined roll";break;case E.RollTypeEnum.attribute:this.diceNumber=this.token.getAttribute(this.key),this.rollName=I(this.key)??"undefined roll";break}}async characterRoll(){await this.determineDicesForRoll(),await game.alienrpg.yze.yzeRoll("character",!1,this.isPush,this.rollName,this.diceNumber,game.i18n.localize("ALIENRPG.Black"),this.token.getStressValue(),game.i18n.localize("ALIENRPG.Yellow"),this.token.getActor().id,"randomStringValue",1,null)}};S(E,"RollTypeEnum",{skill:"skill",attribute:"attribute"});let y=E;class q{static getDicesFromRoll(t){let e=0,n=0;return t==null||t.terms.forEach((s,o)=>{Array.isArray(s==null?void 0:s.results)&&(e+=s.results.filter(r=>r.result===6).length,n+=o!==0?s.results.filter(r=>r.result===1).length:0)}),{success:e,stress:n}}}class v{constructor(t){var e;if(!t){console.warn("Trigger is not a valid HTML element. Module cannot be set");return}this.trigger=t,this.rootNode=null,this.template="modale.html",this.templateRollLigne="roll-line.html",this.templatePanic="panic-line.html",(e=this.trigger)==null||e.addEventListener("click",()=>this.toggle())}async create(){const t=this,e=f(),n=await N(),s=`${e.templatePath}${this.template}`,o=g.getPlayersFromList(canvas.tokens.placeables),r=n.skills,a=n.attributes,l=H(r,a),c=await renderTemplate(s,{tokens:o,skills:l,attributes:a}),u=new Dialog({title:game.i18n.localize("DICEROLLREQUEST.MODALE.modaleTitle"),content:c,buttons:{},render:d=>{let h=d==null?void 0:d.closest(".dialog");if(!h.find(".header-button.minimize").length){let k=h==null?void 0:h.find(".window-header .close"),p=$(`<a class="header-button control minimize">${game.i18n.localize("DICEROLLREQUEST.MODALE.minimizeButton")}</a>`);p==null||p.on("click",()=>{var R;return(R=t.rootNode)==null?void 0:R.minimize()}),k.before(p)}t.applyFormListeners(d),this.syncPanic(...o)},close:()=>{t.rootNode=null}},{width:600});u.render(!0),t.rootNode=u}toggle(){if(!this.rootNode){this.create();return}this.rootNode.close()}async update(){var l;if(!this.rootNode)return;const t=f(),e=await N(),n=`${t.templatePath}${this.template}`,s=g.getPlayersFromList(canvas.tokens.placeables),o=e.skills,r=e.attributes,a=await renderTemplate(n,{tokens:s,skills:o,attributes:r});this.rootNode.data.content=a,(l=this.rootNode)==null||l.render(!0)}applyFormListeners(t){document.getElementById("arr-roll-button").addEventListener("click",()=>{this.formAction()}),t.find(".arr-attribute-input").on("change",function(){this.checked&&t.find(".arr-skill-input").prop("checked",!1)}),t.find(".arr-skill-input").on("change",function(){this.checked&&t.find(".arr-attribute-input").prop("checked",!1)}),document.getElementById("arr-cleanup-pending-requests").addEventListener("click",()=>{m.cleanChatMessageByClassName("alien-request-roll"),ui.notifications.warn(game.i18n.localize("DICEROLLREQUEST.MODALE.pendingNotificationsCleared"))}),document.getElementById("arr-update-modal-content").addEventListener("click",()=>{this.update()})}formAction(){var l,c;const t=Array.from(document.querySelectorAll(".arr-token-input:checked")).map(u=>u.value),e=document.querySelector(".arr-attribute-input:checked"),n=document.querySelector(".arr-skill-input:checked"),s=e?y.RollTypeEnum.attribute:y.RollTypeEnum.skill,o=e?e==null?void 0:e.value:n==null?void 0:n.value,r=(l=document.querySelector("#arr-roll-for-missing:checked"))==null?void 0:l.checked,a=(c=document.querySelector("#arr-force-for-present:checked"))==null?void 0:c.checked;if(t.length<1||!o){ui.notifications.warn(game.i18n.localize("DICEROLLREQUEST.MODALE.noElementSelectedNotification"));return}t.forEach(u=>{const d=g.getTokenFromId(u);if(!d)return;const h=new y(d,s,o),k=d.getOwners(!0);(k.length===0?r:a)?h.characterRoll():h.createRollNotification(k==null?void 0:k.map(p=>p.id))})}async logRollResult(t,e){const n=document.querySelector(`#arr-token-item-${t.getId()} .arr-last-roll-result`);if(!n)return;const o=`${f().templatePath}${this.templateRollLigne}`,r=q.getDicesFromRoll(e);n.innerHTML=await renderTemplate(o,{token:t.token,roll:r}),await this.syncPanic(t)}async syncPanic(...t){const e=f();[...t].forEach(async n=>{n=n instanceof g?n:g.getTokenFromId((n==null?void 0:n.id)??n);const s=document.querySelector(`#arr-token-item-${n.getId()} .arr-panic-state`);if(!s)return;const o={isPanic:n.getPanicValue(),panicMessage:n.getLastPanicMessage()},r=`${e.templatePath}${this.templatePanic}`,a=await renderTemplate(r,{token:n.token,panic:o});s.innerHTML=a})}}Hooks.once("ready",async()=>{if(f(),Handlebars.registerHelper("localizeByKey",function(i){return I(i)}),game.user.isGM){const i=new v(document.querySelector("#chat-controls .chat-control-icon"));m.cleanChatMessageByClassName("alien-request-roll"),m.setMessageCreationListener(i),Hooks.on("createToken",t=>{i.update()}),Hooks.on("deleteToken",t=>{i.update()})}m.setCommonListeners()});Hooks.once("init",()=>{O()});
